<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Flask Demo</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Logo -->
  <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo"
       style="position: absolute; top: 10px; right: 10px; width: 100px; cursor:pointer;"
       onclick="window.location.href='https://ixlabs.ie.edu/';">

  <h1>Flask Demo</h1>

  <!-- ===================== CONTROLS ===================== -->
  <div id="controls">
    <div style="display:flex;justify-content:flex-start;align-items:center;gap:2rem;width:100%;">
      <!-- Year slider -->
      <div style="display:flex;align-items:center;gap:0.5rem;flex-grow:1;">
        <label for="yearSlider">Select Year:</label>
        <input type="range" class="slider" min="{{ min_year }}" max="{{ max_year }}" value="2025" step="1" id="yearSlider">
        <span id="yearLabel">2025</span>
      </div>
      <!-- Metric selector -->
      <div style="display:flex;align-items:center;gap:0.5rem;">
        <label for="metricSelect">Dataset:</label>
        <select id="metricSelect">
          <option value="mortality_rate">Mortality</option>
          <option value="population_density">Population Density</option>
          <option value="temperature" selected>Temperature</option>
        </select>
      </div>
    </div>
    <!-- Week slider -->
    <div style="display:flex;align-items:center;gap:0.5rem;width:100%;">
      <label for="weekSlider">Select Week:</label>
      <input type="range" class="slider" min="1" max="52" value="1" step="1" id="weekSlider">
      <span id="weekLabel">1</span>
    </div>
  </div>

  <!-- ===================== MAP & GRAPH ===================== -->
  <div id="map" style="height:600px;"></div>
  <div id="graph-container" style="display:flex;align-items:flex-start;width:80%;margin:auto;">
    <div id="graph" style="flex:1;height:300px;"></div>
    <div id="info-popup" style="flex:0.5;display:none">
      <h3>Statistics</h3>
      <p><strong>Region Name:</strong> <span id="regionName"></span></p>
      <p><strong><span id="metricLabelPopup">Estimated Metric (Next Year):</span></strong> <span id="estimatedValue"></span></p>
      <p><strong>Estimated Change:</strong> <span id="percentageChange"></span>%</p>
    </div>
  </div>

  <!-- ===================== DATA SOURCES ===================== -->
  <div style="width:80%;margin:1rem auto 0;text-align:left;">
    <h3>Data Sources</h3>
    <ul id="data-sources" style="margin:0;font-size:0.9rem;color:#555;list-style:none;padding-left:1rem;">
      <li><strong>Temperature:</strong> EURO-CORDEX <code>tas</code> projections</li>
      <li><strong>Mortality:</strong> Eurostat <code>demomwk</code> weekly deaths</li>
      <li><strong>Demography:</strong> Eurostat EUROPOP 2023 baseline</li>
    </ul>
  </div>

  <!-- ===================== SCRIPTS ===================== -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    /* ---------- GLOBAL STATE ---------- */
    let currentMetric = 'temperature';
    const map = L.map('map').setView([parseFloat("{{ center_lat }}"), parseFloat("{{ center_lon }}")], parseInt("{{ zoom }}",10));
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    let geoJsonLayer = null;

    /* ---------- DATA LOADING ---------- */
    function loadDataForYear(region, year, week){
      fetch(`/api/data?region=${region}&year=${year}&week=${week}&metric=${currentMetric}`)
        .then(r=>r.json())
        .then(data=>{
          if(geoJsonLayer) map.removeLayer(geoJsonLayer);
          geoJsonLayer=L.geoJSON(data,{
            style: featureStyle,
            onEachFeature: onEachRegion
          }).addTo(map);
        })
        .catch(err=>console.error('Error fetching data:',err));
    }

    /* ---------- STYLING ---------- */
    function featureStyle(feat){
      const p = feat.properties;
      let fill='#999', val=0;
      if(currentMetric==='mortality_rate'){
        val=p.mortality_rate??0; fill=`rgb(0,${Math.min(val*5,255)},0)`;
      }else if(currentMetric==='population_density'){
        val=p.population_density??0; fill=`rgb(${Math.min(val,255)},0,0)`;
      }else if(currentMetric==='temperature'){
        val=p.temperature??0; fill=`rgb(${Math.min((val+20)*5,255)},0,0)`;
      }
      return{fillColor:fill,fillOpacity:0.7,weight:1,color:'#666'};
    }

    /* ---------- POPUPS & INTERACTION ---------- */
    function onEachRegion(feat,layer){
      const p=feat.properties;
      const lines=[
        `<b>${p.name}</b>`,
        `Mortality: ${p.mortality_rate??'n/a'} per 100k`,
        `Population Density: ${p.population_density??'n/a'} per km²`,
        `Temperature: ${p.temperature??'n/a'} °C`
      ];
      if(p.name==='Austria') lines.push(`<button onclick=\"window.location.href='/austria'\">Go to Austria</button>`);
      layer.bindPopup(lines.join('<br>'));
      layer.on('click',()=>plotGraphFromAPI(p.NUTS_ID,p.name));
    }

    /* ---------- GRAPH & INFO PANEL ---------- */
    function updateInfoPopup(word,name,val,pct){
      document.getElementById('regionName').innerText=name;
      document.getElementById('metricLabelPopup').innerText=`Estimated ${word} (Next Year):`;
      document.getElementById('estimatedValue').innerText=val;
      document.getElementById('percentageChange').innerText=pct;
      document.getElementById('info-popup').style.display='block';
    }

    function plotGraphFromAPI(nuts_id,name){
      const word=currentMetric==='mortality_rate'?'Mortality (per 100k)':currentMetric==='population_density'?'Population Density (km²)':'Temperature (°C)';
      fetch(`/api/data/ts?region={{ region }}&metric=${currentMetric}&nuts_id=${nuts_id}`)
        .then(r=>r.json())
        .then(res=>{
          if(!res.data) return;
          const labels=res.data.map(d=>`${d.year}-W${String(d.week).padStart(2,'0')}`);
          const values=res.data.map(d=>d.value);
          const gDiv=document.getElementById('graph'); gDiv.innerHTML='';
          const canvas=document.createElement('canvas'); gDiv.appendChild(canvas);
          new Chart(canvas.getContext('2d'),{
            type:'line',data:{labels,datasets:[{label:`${word} for ${name}`,data:values,borderColor:'#6dc201',backgroundColor:'#6dc2014D',fill:true,tension:0.2}]},
            options:{responsive:true,maintainAspectRatio:false,scales:{x:{ticks:{autoSkip:true,maxTicksLimit:12}},y:{beginAtZero:true}}}
          });
          const pct=(Math.random()*5+1).toFixed(2); const cur=values[values.length-1]; const est=(cur*(1+pct/100)).toFixed(2);
          updateInfoPopup(word,name,est,pct);
        }).catch(err=>console.error('Error loading TS:',err));
    }

    /* ---------- EVENT HANDLERS ---------- */
    let timer;
    document.getElementById('yearSlider').addEventListener('input',function(){
      clearTimeout(timer); const y=this.value; document.getElementById('yearLabel').innerText=y;
      timer=setTimeout(()=>loadDataForYear("{{ region }}",y,document.getElementById('weekSlider').value),300);
    });
    document.getElementById('weekSlider').addEventListener('input',function(){
      clearTimeout(timer); const w=this.value; document.getElementById('weekLabel').innerText=w;
      timer=setTimeout(()=>loadDataForYear("{{ region }}",document.getElementById('yearSlider').value,w),300);
    });
    document.getElementById('metricSelect').addEventListener('change',function(){
      currentMetric=this.value; const y=document.getElementById('yearSlider').value; const w=document.getElementById('weekSlider').value;
      loadDataForYear("{{ region }}",y,w); document.getElementById('graph').innerHTML=''; document.getElementById('info-popup').style.display='none';
    });

    /* ---------- INITIALISATION ---------- */
    loadDataForYear("{{ region }}","{{ max_year }}",1);
  </script>
</body>
<footer>
  <p>Demo by <a href="http://danielprecioso.com" target="_blank">Daniel Precioso</a> for IE University. For demonstration purposes only.</p>
</footer>
</html>
