<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Flask Demo</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- Chart.js for plotting graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Logo in the top right -->
  <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo"
       style="position: absolute; top: 10px; right: 10px; width: 100px; height: auto; cursor: pointer;"
       onclick="window.location.href='https://ixlabs.ie.edu/';">

  <h1>Flask Demo</h1>

  <!-- *** CONTROLS *** -->
  <div id="controls">

    <!-- Top row: year slider + metric selector -->
    <div style="display: flex; justify-content: flex-start; align-items: center; gap: 2rem; width: 100%;">
      
      <!-- Year slider -->
      <div style="display: flex; align-items: center; gap: 0.5rem; flex-grow: 1;">
        <label for="yearSlider">Select Year:</label>
        <input type="range" class="slider" min="{{ min_year }}" max="{{ max_year }}" value="{{ max_year }}" step="1" id="yearSlider">
        <span id="yearLabel">{{ max_year }}</span>
      </div>

      <!-- Metric selector -->
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <label for="metricSelect">Dataset:</label>
        <select id="metricSelect">
          <option value="mortality_rate">Mortality</option>
          <option value="population_density">Population Density</option>
          <option value="temperature" selected>Temperature</option>
        </select>
      </div>

    </div>

    <!-- Bottom row: week slider -->
    <div style="display: flex; align-items: center; gap: 0.5rem; width: 100%;">
      <label for="weekSlider">Select Week:</label>
      <input type="range" class="slider" min="1" max="52" value="1" step="1" id="weekSlider">
      <span id="weekLabel">1</span>
    </div>

  </div>

  <!-- *** MAP & GRAPH SECTION *** -->
  <div id="map"></div>
  <div id="graph-container" style="display: flex; align-items: flex-start; width: 80%; align-self: center; margin: auto auto;">
    <div id="graph" style="flex: 1;"></div>
    <div id="info-popup" style="flex: 0.5; display:none">
      <h3 id="info-title">Statistics</h3>
      <p><strong>Region Name:</strong> <span id="regionName"></span></p>
      <p><strong><span id="metricLabelPopup">Estimated Value (Next Year):</span></strong> <span id="estimatedValue"></span></p>
      <p><strong>Estimated Change:</strong> <span id="percentageChange"></span>%</p>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    /* ------------------------- GLOBAL STATE ------------------------- */
    // Current dataset the user wants to visualise.
    let currentMetric = 'temperature';

    // Initialise Leaflet map using backend values
    const default_zoom = parseInt("{{ zoom }}", 10);
    const default_center = [parseFloat("{{ center_lat }}"), parseFloat("{{ center_lon }}")];
    const map = L.map('map').setView(default_center, default_zoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    let geoJsonLayer = null;

    /* ------------------------- DATA LOADING ------------------------- */
    // Fetch data for a given region/year/metric and refresh the layer
    function loadDataForYear(region, year, week) {
      fetch(`/api/data?region=${region}&year=${year}&week=${week}&metric=${currentMetric}`)
        .then(response => response.json())
        .then(data => {
          if (geoJsonLayer) {
            map.removeLayer(geoJsonLayer);
          }

          geoJsonLayer = L.geoJSON(data, {
            style: feature => featureStyle(feature),
            onEachFeature: (feature, layer) => onEachRegion(feature, layer)
          }).addTo(map);
        })
        .catch(error => console.error('Error fetching data:', error));
    }

    // Colour/opacity rules depending on the selected metric
    function featureStyle(feature) {
      const props = feature.properties;
      let value = 0;
      let fillColor = '#999';

      if (currentMetric === 'mortality_rate') {
        value = props.mortality_rate || 0;           // deaths per thousand
        const intensity = Math.min(value * 5, 255);
        fillColor = `rgb(0, ${intensity}, 0)`;       // green ramp
      } else if (currentMetric === 'population_density') {
        value = props.population_density || 0;       // pop per km²
        const intensity = Math.min(value, 255);
        fillColor = `rgb(${intensity}, 0, 0)`;       // red ramp
      } else if (currentMetric === 'temperature') {
        value = props.temperature || 0;             // °C
        // Map -20 -> 0 °C to blue, 0 -> 20 °C to light blue, 20 -> 40 °C to red-ish
        const norm   = Math.max(Math.min(value + 20, 40), 0); // 0–40
        const red    = Math.round((norm / 40) * 255);
        const blue   = 255 - red;
        fillColor = `rgb(${red}, 0, ${blue})`;
      }

      return {
        fillColor,
        fillOpacity: 0.7,
        weight: 1,
        color: '#666'
      };
    }

    /* ------------------------- INTERACTION ------------------------- */
    function onEachRegion(feature, layer) {
      const props = feature.properties;

      let metricLabel, metricVal;
      if (currentMetric === 'mortality_rate') {
        metricLabel = 'Mortality';
        metricVal   = props.mortality_rate;
      } else if (currentMetric === 'population_density') {
        metricLabel = 'Population Density (km²)';
        metricVal   = props.population_density;
      } else {
        metricLabel = 'Temperature (°C)';
        metricVal   = props.temperature;
      }

      const valueText = metricVal !== undefined && metricVal !== null ? metricVal.toFixed(1) : 'N/A';

      // Popup
      layer.bindPopup(`<b>${props.name}</b><br>${metricLabel}: ${valueText}`);

      // Click -> show graph and stats
      layer.on('click', () => plotGraphFromAPI(props.NUTS_ID, props.name, metricLabel));
    }

    // Update the info side‑panel
    function updateInfoPopup(properties, metricLabel, metricKey) {
      const currentVal = properties[metricKey] || 0;
      const percentageChange = (Math.random() * 5 + 1).toFixed(2); // placeholder demo
      const estimatedVal     = (currentVal * (1 + percentageChange / 100)).toFixed(1);

      document.getElementById('regionName').innerText       = properties.name;
      document.getElementById('metricLabelPopup').innerText = `Estimated ${metricLabel} (Next Year):`;
      document.getElementById('estimatedValue').innerText   = estimatedVal;
      document.getElementById('percentageChange').innerText = percentageChange;
      document.getElementById('info-popup').style.display   = 'block';
    }

    // Draw line‑chart for selected region using /api/data/ts
    function plotGraphFromAPI(nuts_id, name, metricLabel) {
      fetch(`/api/data/ts?region={{ region }}&metric=${currentMetric}&nuts_id=${nuts_id}`)
        .then(response => response.json())
        .then(result => {
          if (!result.data) return;

          const labels = result.data.map(d => `${d.year}-W${String(d.week).padStart(2, '0')}`);
          const values = result.data.map(d => d.value);

          // Clear previous graph and create new canvas
          const graphDiv = document.getElementById('graph');
          graphDiv.innerHTML = '';
          const canvas = document.createElement('canvas');
          graphDiv.appendChild(canvas);
          const ctx = canvas.getContext('2d');

          new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: `${metricLabel} for ${name}`,
                data: values,
                borderColor: '#6dc201',
                backgroundColor: '#6dc2014D',
                fill: true,
                tension: 0.2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  ticks: {
                    autoSkip: true,
                    maxTicksLimit: 12
                  }
                },
                y: {
                  beginAtZero: false
                }
              }
            }
          });

          // Update side‑panel with the latest datapoint
          const latest = result.data[result.data.length - 1] || {};
          const propsForInfo = { name: name };
          propsForInfo[metricLabel] = latest.value;
          updateInfoPopup(propsForInfo, metricLabel, metricLabel);
        })
        .catch(error => console.error("Error loading time series:", error));
    }

    /* ------------------------- EVENT HANDLERS ------------------------- */
    // Year slider (with debounce)
    let debounceTimer;
    document.getElementById('yearSlider').addEventListener('input', function () {
      clearTimeout(debounceTimer);
      const year = this.value;
      document.getElementById('yearLabel').innerText = year;
      debounceTimer = setTimeout(() => {
        loadDataForYear("{{ region }}", year, document.getElementById('weekSlider').value);
      }, 300);
    });

    // Week slider
    document.getElementById('weekSlider').addEventListener('input', function () {
      const week = this.value;
      document.getElementById('weekLabel').innerText = week;
      debounceTimer = setTimeout(() => {
        loadDataForYear("{{ region }}", document.getElementById('yearSlider').value, week);
      }, 300);
    });

    // Metric dropdown
    document.getElementById('metricSelect').addEventListener('change', function () {
      currentMetric = this.value;
      const selectedYear = document.getElementById('yearSlider').value;
      const selectedWeek = document.getElementById('weekSlider').value;
      loadDataForYear("{{ region }}", selectedYear, selectedWeek);
      // Clear graph/info panel until user clicks again
      document.getElementById('graph').innerHTML = '';
      document.getElementById('info-popup').style.display = 'none';
    });

    /* ------------------------- INITIALISATION ------------------------- */
    loadDataForYear("{{ region }}", "{{ max_year }}", 1);
  </script>
</body>
<!-- Footer Section -->
<footer>
  <p>Demo by <a href="http://danielprecioso.com" target="_blank">Daniel Precioso</a> for IE University. This tool is for demonstration purposes only. The data displayed may not represent real‑world scenarios.</p>
</footer>
</html>
